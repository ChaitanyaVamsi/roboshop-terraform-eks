pipeline {
  agent any

/*  // for specific node
  agent{
    node{
      label 'slave'
    }
  }
   */
  environment {
    PROJECT = 'roboshop'
    COMPONENT = 'catalogue'
  }

  options {
    timeout(time:10, unit: 'MINUTES')
    disableConcurrentBuilds()
    ansiColor('xterm')
  }

  stages {
    stage('init') {
      steps {
        withAWS(region:'us-east-1', credentials:'aws-creds') {
          sh '''
          cd 00-vpc
          terraform init
        '''}
      }
    }

    stage('Plan') {
      steps {
        withAWS(region:'us-east-1', credentials:'aws-creds') { sh """
        cd 00-vpc
        terraform plan
      """}
      }
    }

    stage('Deploy') {
      input {
        message 'Should we continue?'
        ok 'Yes, we should.'
        submitter 'alice,bob'
        parameters {
          string(name: 'PERSON', defaultValue: 'Mr Jenkins', description: 'Who should I say hello to?')
        }
      }
      steps {
        withAWS(region:'us-east-1', credentials:'aws-creds') {
              sh '''
              cd 00-vpc
                    terraform apply -auto-approve
                '''
            }}
      }

      stage('Trigger downstream job'){
        steps{
          script{
            build job: '10-sg',
            wait: false,
            propogate:false
          }
        }
      }
    }
  }
